name: ğŸ“š Sync Wiki Documentation

on:
  push:
    branches: [ main ]
    paths: [ 'wiki/**' ]
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes detected'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    name: ğŸ”„ Sync Wiki Pages
    
    steps:
      - name: ğŸ“¥ Checkout main repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Check if wiki directory exists
        run: |
          if [ ! -d "wiki" ]; then
            echo "âŒ Wiki directory not found"
            exit 1
          fi
          echo "âœ… Wiki directory found"
          echo "ğŸ“Š Wiki files: $(find wiki -name "*.md" | wc -l)"

      - name: ğŸ“¥ Checkout Wiki repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki-repo
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: ğŸ†• Initialize Wiki if not exists
        if: failure()
        run: |
          echo "ğŸ†• Wiki repository doesn't exist, creating..."
          mkdir -p wiki-repo
          cd wiki-repo
          git init
          git remote add origin https://github.com/${{ github.repository }}.wiki.git
          
          # Create initial commit
          echo "# Welcome to Vidzilla Wiki" > Home.md
          echo "" >> Home.md
          echo "This wiki is automatically synced from the main repository." >> Home.md
          
          git config user.name 'wiki-sync-bot'
          git config user.email 'wiki-sync-bot@users.noreply.github.com'
          git add Home.md
          git commit -m "ğŸ‰ Initialize wiki repository"
          git push -u origin master

      - name: âš™ï¸ Configure Git
        run: |
          cd wiki-repo
          git config user.name 'wiki-sync-bot'
          git config user.email 'wiki-sync-bot@users.noreply.github.com'

      - name: ğŸ“‹ Sync Wiki content
        run: |
          echo "ğŸ“‹ Copying wiki files..."
          
          # Copy all markdown files
          cp wiki/*.md wiki-repo/ 2>/dev/null || {
            echo "âŒ No markdown files found in wiki directory"
            exit 1
          }
          
          cd wiki-repo
          
          echo "ğŸ“Š Files in wiki repository:"
          ls -la *.md

      - name: ğŸ§­ Create navigation and metadata
        run: |
          cd wiki-repo
          
          # Create enhanced sidebar
          cat > _Sidebar.md << 'EOF'
          ## ğŸ“š Vidzilla Wiki
          
          ### ğŸ‘¥ For Users
          * [ğŸ  **Home**](Home)
          * [ğŸš€ Quick Start](Quick-Start-Guide)
          * [ğŸ¯ Supported Platforms](Supported-Platforms)
          * [â“ FAQ](FAQ)
          
          ### ğŸ‘¨â€ğŸ’» For Developers
          * [ğŸ› ï¸ Installation Guide](Installation-Guide)
          * [ğŸ—ï¸ Architecture Overview](Architecture-Overview)
          
          ### ğŸ”— Quick Links
          * [ğŸ“‹ Repository](https://github.com/${{ github.repository }})
          * [ğŸ› Report Bug](https://github.com/${{ github.repository }}/issues/new)
          * [ğŸ’¬ Discussions](https://github.com/${{ github.repository }}/discussions)
          * [ğŸ“Š Actions](https://github.com/${{ github.repository }}/actions)
          
          ---
          
          ### ğŸ“ˆ Stats
          * **Pages:** $(find . -name "*.md" -not -name "_*" | wc -l)
          * **Last Sync:** $(date '+%Y-%m-%d %H:%M UTC')
          
          ---
          *ğŸ¤– Auto-generated navigation*
          EOF
          
          # Create enhanced footer
          cat > _Footer.md << 'EOF'
          ---
          
          ### ğŸ“š Documentation Info
          
          | Info | Value |
          |------|-------|
          | ğŸ“… **Last Updated** | $(date '+%Y-%m-%d %H:%M:%S UTC') |
          | ğŸ¤– **Sync Method** | Automated via GitHub Actions |
          | ğŸ“ **Source** | [wiki/ directory](https://github.com/${{ github.repository }}/tree/main/wiki) |
          | âœï¸ **Edit** | [Improve documentation](https://github.com/${{ github.repository }}/tree/main/wiki) |
          | ğŸ› **Issues** | [Report problems](https://github.com/${{ github.repository }}/issues/new) |
          
          ---
          
          **ğŸ¯ Vidzilla** - Social Media Video Downloader Bot  
          â­ [Star us on GitHub](https://github.com/${{ github.repository }}) if you find this useful!
          EOF

      - name: ğŸ” Check for changes
        id: changes
        run: |
          cd wiki-repo
          
          if [[ -n $(git status --porcelain) ]] || [[ "${{ github.event.inputs.force_sync }}" == "true" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected or force sync requested"
            
            # Show what changed
            echo "ğŸ“ Changed files:"
            git status --porcelain
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          fi

      - name: ğŸ“¤ Commit and push changes
        if: steps.changes.outputs.changes == 'true'
        run: |
          cd wiki-repo
          
          # Add all files
          git add .
          
          # Create detailed commit message
          CHANGED_FILES=$(git diff --cached --name-only | tr '\n' ', ' | sed 's/,$//')
          
          cat > commit_message.txt << EOF
          ğŸ“š Auto-sync wiki documentation
          
          ğŸ”„ **Sync Details:**
          - **Trigger:** ${{ github.event_name }}
          - **Branch:** ${{ github.ref_name }}
          - **Commit:** ${{ github.sha }}
          - **Time:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ğŸ“ **Updated Files:** $CHANGED_FILES
          
          ğŸ¤– Automatically synced from main repository
          EOF
          
          # Commit with detailed message
          git commit -F commit_message.txt
          
          # Push changes
          echo "ğŸ“¤ Pushing to GitHub Wiki..."
          git push origin master || git push origin main
          
          echo "âœ… Wiki updated successfully!"

      - name: ğŸ“Š Generate sync report
        if: always()
        run: |
          echo "## ğŸ“š Wiki Sync Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“… Sync Time | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”„ Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ Wiki Pages | $(find wiki -name "*.md" | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š Total Size | $(du -sh wiki | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸŒ **View Wiki:** https://github.com/${{ github.repository }}/wiki" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ‰ Success notification
        if: success() && steps.changes.outputs.changes == 'true'
        run: |
          echo "ğŸ‰ Wiki sync completed successfully!"
          echo "ğŸŒ View updated wiki at: https://github.com/${{ github.repository }}/wiki"